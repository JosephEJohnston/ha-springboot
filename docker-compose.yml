version: '3.8'

services:
  # 1. Zipkin 服务：视频存储站
  zipkin:
    image: openzipkin/zipkin:3.5.1
    container_name: zipkin
    ports:
      - "9411:9411"  # 浏览器访问 http://localhost:9411 查看链路
    networks:
      - monitor-net

  app-server:
    # 关键点 1：指定构建上下文为当前目录
    build:
      context: .
      dockerfile: Dockerfile
    # 关键点 2：构建后的镜像名
    image: ha-springboot:latest
    container_name: monolith-app
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      # 用双引号把这一长串包起来，防止空格或特殊字符解析翻车
      - JAVA_OPTS=-Xms512m -Xmx512m -javaagent:/app/agent/skywalking-agent.jar -XX:StartFlightRecording=disk=true,repository=/tmp/jfr_repo,filename=/app/logs/recording-%t.jfr,dumponexit=true
      - SPRING_PROFILES_ACTIVE=prod

      # 2. SkyWalking 核心配置
      - SW_AGENT_NAME=ha-springboot
      - SW_AGENT_COLLECTOR_BACKEND_SERVICES=sw-oap:11800  # 指向咱们刚配的 10.3.0 OAP 容器

      # 3. 之前辛苦调通的 Zipkin 配置（4.0 规范版）
      # 10.3.0 的 Agent 极其聪明，它会自动识别并抓取 Micrometer 产生的 Trace 信号
      - MANAGEMENT_TRACING_EXPORT_ZIPKIN_ENDPOINT=http://zipkin:9411/api/v2/spans
    restart: always
    healthcheck:
      # 建议：如果 curl 不通，尝试使用 wget -q --spider http://localhost:9090/actuator/health
      test: ["CMD", "curl", "-f", "http://localhost:9090/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 45s # 考虑到 JFR 启动会有额外开销，稍微放宽一点
    volumes:
      - ./logs:/app/logs
      - ./jfr_repo:/tmp/jfr_repo
      - ./skywalking-agent:/app/agent # 别忘了把 agent 包下载到本地这个目录
    networks:
      - monitor-net
    depends_on:
      - zipkin

  # 3. Prometheus 监控服务
  prometheus:
    image: prom/prometheus:v3.9.1
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9000:9090" # 避免和应用管理端口 9090 冲突
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - monitor-net
    depends_on:
      - app-server

  # 1. BanyanDB：10.3.0 的原生存储引擎，比 ES 快得多
  banyandb:
    image: apache/skywalking-banyandb:0.6.1
    container_name: sw-banyandb
    command: standalone
    networks:
      - monitor-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "17912"]
      interval: 5s
      timeout: 3s
      retries: 10

  # 2. SkyWalking OAP：核心收集器，支持 10.3.0 特性
  skywalking-oap:
    image: apache/skywalking-oap-server:10.0.0 # 对应 10.x 系列
    container_name: sw-oap
    depends_on:
      banyandb:
        condition: service_healthy
    networks:
      - monitor-net
    ports:
      - "11800:11800" # gRPC 端口 (Agent 连接)
      - "12800:12800" # HTTP 端口
    environment:
      SW_STORAGE: banyandb
      SW_STORAGE_BANYANDB_TARGETS: banyandb:17912
      JAVA_OPTS: "-Xms512m -Xmx512m"

  # 3. SkyWalking UI：10.3.0 版本的酷炫看板
  skywalking-ui:
    image: apache/skywalking-ui:10.0.0
    container_name: sw-ui
    depends_on:
      - skywalking-oap
    networks:
      - monitor-net
    ports:
      - "8088:8080" # 访问地址：http://localhost:8088
    environment:
      SW_OAP_ADDRESS: http://skywalking-oap:12800

  arthas-tunnel-server:
    build:
      context: .
      dockerfile: Dockerfile.tunnel
    container_name: arthas-tunnel-server
    ports:
      - "8085:8080" # Web 管理后台
      - "7777:7777" # Agent 通讯端口
    restart: unless-stopped
    networks:
      - monitor-net

networks:
  monitor-net:
    driver: bridge
