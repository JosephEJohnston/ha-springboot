version: '3.8'

services:
  # 单体应用服务
  app-server:
    image: ha-springboot:latest  # 请替换为您实际的镜像名称
    container_name: monolith-app
    ports:
      - "8080:8080"
    environment:
      - JAVA_OPTS=-Xms512m -Xmx512m
      - SPRING_PROFILES_ACTIVE=prod
    # 2. 设置 restart: always，确保进程挂掉后秒级拉起
    restart: always
    # 1. healthcheck 配置
    healthcheck:
      # 使用 curl 检查健康端点，如果镜像内没有 curl，可改为 wget -q --spider http://localhost:8080/actuator/health || exit 1
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s       # 每 10s 检查一次
      timeout: 5s         # 超时时间
      retries: 3          # 连续失败 3 次标记为 unhealthy
      start_period: 30s   # 给应用 30s 的启动缓冲时间，期间不计入失败
    networks:
      - monitor-net

  # Prometheus 监控服务
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      # 将当前目录下的 prometheus.yml 挂载到容器内
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - monitor-net
    depends_on:
      - app-server

networks:
  monitor-net:
    driver: bridge
