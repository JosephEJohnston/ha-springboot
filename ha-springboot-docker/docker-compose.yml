version: '3.8'

services:
  # 1. Zipkin 服务：视频存储站
  zipkin:
    image: openzipkin/zipkin:latest
    container_name: zipkin
    ports:
      - "9411:9411"  # 浏览器访问 http://localhost:9411 查看链路
    networks:
      - monitor-net

  app-server:
    image: ha-springboot:latest
    container_name: monolith-app
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      # 修正 1：改为连续空格分隔；修正 2：文件名增加时间戳 %t 防止覆盖
      - JAVA_OPTS=-Xms512m -Xmx512m -XX:StartFlightRecording=disk=true,repository=/tmp/jfr_repo,filename=/app/logs/recording-%t.jfr,dumponexit=true
      - SPRING_PROFILES_ACTIVE=prod
      # 修正 3：确保环境变量名匹配 Spring Boot 3.x 规范
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
    restart: always
    healthcheck:
      # 建议：如果 curl 不通，尝试使用 wget -q --spider http://localhost:9090/actuator/health
      test: ["CMD", "curl", "-f", "http://localhost:9090/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 45s # 考虑到 JFR 启动会有额外开销，稍微放宽一点
    volumes:
      - ./logs:/app/logs
      - ./jfr_repo:/tmp/jfr_repo
    networks:
      - monitor-net
    depends_on:
      - zipkin

  # 3. Prometheus 监控服务
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9000:9090" # 避免和应用管理端口 9090 冲突
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - monitor-net
    depends_on:
      - app-server

networks:
  monitor-net:
    driver: bridge
